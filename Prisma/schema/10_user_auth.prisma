// ============================================================================
// CORE USER & AUTH MODELS
// ============================================================================

model User {
  id                String    @id @default(uuid())
  username          String    @unique
  email             String    @unique
  phone             String?
  passwordHash      String    @map("password_hash")

  // Account security
  passwordUpdatedAt DateTime? @map("password_updated_at")
  lastLoginAt       DateTime? @map("last_login_at")
  failedLoginCount  Int       @default(0) @map("failed_login_count")
  lockedUntil       DateTime? @map("locked_until")

  // MFA (store encrypted secret; never plaintext)
  mfaEnabled        Boolean   @default(false) @map("mfa_enabled")
  totpSecretEnc     String?   @map("totp_secret_enc") @db.Text
  backupCodesHash   Json?     @map("backup_codes_hash")

  emailVerifiedAt   DateTime? @map("email_verified_at")
  kycStatus         KYCStatus @default(NONE) @map("kyc_status")
  reputationScore   Decimal   @default(0) @db.Decimal(3, 2)
  totalTransactions Int       @default(0) @map("total_transactions")
  isAdmin           Boolean   @default(false) @map("is_admin")

  // Soft delete with FK to admin user
  deletedAt         DateTime? @map("deleted_at")
  deletedByUserId   String?   @map("deleted_by_user_id")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  wallet               Wallet?
  sessions             Session[]
  bankAccounts         BankAccount[]
  ordersInitiated      Order[]               @relation("OrderInitiator")
  ordersCounterparty   Order[]               @relation("OrderCounterparty")
  ordersDeleted        Order[]               @relation("OrderDeletedBy")
  ratingsGiven         Rating[]              @relation("RatingFrom")
  ratingsReceived      Rating[]              @relation("RatingTo")
  disputesOpened       Dispute[]             @relation("DisputeOpener")
  disputesArbitrated   Dispute[]             @relation("DisputeArbitrator")
  disputeEscalations   Dispute[]             @relation("DisputeEscalation")
  kycSubmissions       KYCSubmission[]       @relation("KYCUser")
  kycVerifications     KYCSubmission[]       @relation("KYCVerifier")
  payments             Payment[]
  orderComments        OrderComment[]
  auditLogs            AuditLog[]
  notifications        Notification[]
  disputeEvidences     DisputeEvidence[]
  withdrawalsRequested Withdrawal[]          @relation("WithdrawalRequester")
  withdrawalsApproved  Withdrawal[]          @relation("WithdrawalApprover")
  withdrawalReviews    Withdrawal[]          @relation("WithdrawalReviewer")
  withdrawalApprovals  WithdrawalApproval[]  @relation("WithdrawalApprovalUser")
  disputeTimelines     DisputeTimeline[]
  ratingModerations    Rating[]              @relation("RatingModerator")

  // User deletion actor relation (User deleted by another User)
  deletedByActions     User[]                @relation("DeletedBy")
  deletedBy            User?                 @relation("DeletedBy", fields: [deletedByUserId], references: [id], onDelete: SetNull)

  // Referral system
  referralCode         ReferralCode?
  referralsUsed        ReferralUsage[]       @relation("ReferredUser")
  referralsSent        ReferralUsage[]       @relation("ReferrerUser")
  referralRewards      ReferralReward[]

  // Promo & Voucher
  voucherUsages        VoucherUsage[]
  promoAssignments     PromoAssignment[]
  vouchersAssigned     Voucher[]             @relation("VoucherAssignedTo")

  // Activity Log
  activities           UserActivity[]

  // Transaction Limits
  transactionLimits    TransactionLimit[]    @relation("TransactionLimitUser")

  // Order Settlement (CRITICAL FIX)
  settlementsAsSeller  OrderSettlement[]     @relation("SettlementSeller")
  settlementsAsBuyer   OrderSettlement[]     @relation("SettlementBuyer")

  @@index([kycStatus])
  @@index([kycStatus, emailVerifiedAt])
  @@index([deletedAt])
  @@index([isAdmin, deletedAt])
  @@map("users")
}

model Session {
  id                  String    @id @default(uuid())
  userId              String    @map("user_id")
  refreshHash         String    @map("refresh_hash")
  userAgent           String?   @map("user_agent")
  ipAddress           String?   @map("ip_address")
  revokedAt           DateTime? @map("revoked_at")
  expiresAt           DateTime  @map("expires_at")
  createdAt           DateTime  @default(now()) @map("created_at")

  // Session rotation & token family
  sessionFamilyId     String?   @map("session_family_id")
  rotatedAt           DateTime? @map("rotated_at")
  replacedBySessionId String?   @map("replaced_by_session_id")

  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  replacedBy          Session?  @relation("SessionRotation", fields: [replacedBySessionId], references: [id], onDelete: SetNull)
  replacements        Session[] @relation("SessionRotation")

  @@index([userId, expiresAt])
  @@index([sessionFamilyId])
  @@map("sessions")
}
