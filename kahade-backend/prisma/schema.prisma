// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
}

enum TransactionStatus {
  PENDING
  PAYMENT_CONFIRMED
  COMPLETED
  DISPUTED
  CANCELLED
  REFUNDED
}

enum DisputeStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  REJECTED
}

enum NotificationType {
  TRANSACTION
  DISPUTE
  PAYMENT
  SYSTEM
}

// ==================== MODELS ====================

// User and Authentication
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  phone     String?
  avatar    String?
  bio       String?
  role      UserRole @default(USER)
  status    UserStatus @default(ACTIVE)
  
  // Email verification
  emailVerified Boolean @default(false)
  emailVerifiedAt DateTime?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?
  
  // Relations
  buyerTransactions  Transaction[] @relation("BuyerTransactions")
  sellerTransactions Transaction[] @relation("SellerTransactions")
  disputes          Dispute[]
  notifications     Notification[]
  
  @@map("users")
}

// Transaction and Escrow
model Transaction {
  id          String            @id @default(uuid())
  title       String
  description String?
  amount      Decimal           @db.Decimal(15, 2)
  currency    String            @default("IDR")
  status      TransactionStatus @default(PENDING)
  
  // Blockchain integration
  blockchainTxHash String?
  
  // Payment tracking
  paymentId   String?
  paidAt      DateTime?
  completedAt DateTime?
  cancelledAt DateTime?
  refundedAt  DateTime?
  
  // Participants
  buyerId  String
  buyer    User   @relation("BuyerTransactions", fields: [buyerId], references: [id])
  sellerId String
  seller   User   @relation("SellerTransactions", fields: [sellerId], references: [id])
  
  // Relations
  disputes Dispute[]
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@map("transactions")
}

// Dispute Resolution
model Dispute {
  id          String        @id @default(uuid())
  reason      String
  description String
  status      DisputeStatus @default(PENDING)
  resolution  String?
  
  // Timing
  resolvedAt DateTime?
  
  // Participants
  reporterId String
  reporter   User   @relation(fields: [reporterId], references: [id])
  
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([transactionId])
  @@index([reporterId])
  @@index([status])
  @@map("disputes")
}

// Notification
model Notification {
  id      String           @id @default(uuid())
  type    NotificationType
  title   String
  message String
  read    Boolean          @default(false)
  
  // Metadata
  metadata Json?
  
  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id])
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([read])
  @@map("notifications")
}
