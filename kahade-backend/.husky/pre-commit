#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit security checks..."
echo ""

# Run lint-staged
echo "üìù Linting staged files..."
npx lint-staged

if [ $? -ne 0 ]; then
  echo "‚ùå Lint check failed!"
  exit 1
fi

echo "‚úÖ Lint check passed"
echo ""

# Check for potential secrets in staged files
echo "üîí Checking for secrets in staged files..."

SECRET_FOUND=0

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

for FILE in $STAGED_FILES; do
  # Only check relevant file types
  if echo "$FILE" | grep -qE "\.(ts|js|json|env|yml|yaml|config)$"; then
    
    # Check for common secret patterns
    if git show ":$FILE" 2>/dev/null | grep -qEi "(password|secret|api[_-]?key|private[_-]?key|token|auth[_-]?token).*[=:].+"; then
      
      # Exclude if it's a placeholder or example
      if ! git show ":$FILE" 2>/dev/null | grep -qEi "(CHANGE_THIS|YOUR_|EXAMPLE_|PLACEHOLDER|DUMMY|<.*>|\[.*\]|xxx|yyy|zzz|test|sample|demo)"; then
        
        echo "‚ö†Ô∏è  Potential secret detected in: $FILE"
        
        # Show the suspicious lines (first 3 matches)
        git show ":$FILE" 2>/dev/null | grep -Ei "(password|secret|api[_-]?key|private[_-]?key|token).*[=:].+" | head -n 3
        
        SECRET_FOUND=1
      fi
    fi
  fi
done

if [ $SECRET_FOUND -eq 1 ]; then
  echo ""
  echo "‚ùå Potential secrets found in staged files!"
  echo "üìã Please review the files above and:"
  echo "   1. Remove any real secrets"
  echo "   2. Use environment variables instead"
  echo "   3. Add to .env.example with placeholder values"
  echo ""
  echo "üí° To bypass this check (NOT recommended):"
  echo "   git commit --no-verify"
  echo ""
  exit 1
fi

echo "‚úÖ No secrets detected"
echo ""

# Optional: Check for .env files
if echo "$STAGED_FILES" | grep -qE "\.env(\..+)?$"; then
  echo "‚ö†Ô∏è  WARNING: You are committing .env files!"
  echo "‚ùå This is NOT allowed for security reasons."
  echo ""
  echo "Files detected:"
  echo "$STAGED_FILES" | grep -E "\.env(\..+)?$"
  echo ""
  echo "Please unstage these files:"
  echo "  git reset HEAD <file>"
  echo ""
  exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
echo ""